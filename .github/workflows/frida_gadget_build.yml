name: build-frida-gadget-android-arm64

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch/tag/sha)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git python3 python3-pip python3-setuptools python3-wheel \
            ninja-build meson pkg-config \
            build-essential clang \
            bison flex \
            curl wget xz-utils unzip

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK + NDK r25
        run: |
          SDK_ROOT="$GITHUB_WORKSPACE/android-sdk"
          mkdir -p "$SDK_ROOT/cmdline-tools"
          cd "$SDK_ROOT"
          curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q cmdline-tools.zip -d "$SDK_ROOT/cmdline-tools"
          mv "$SDK_ROOT/cmdline-tools/cmdline-tools" "$SDK_ROOT/cmdline-tools/latest"
          yes | "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK_ROOT" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.2.9519653"
          echo "ANDROID_SDK_ROOT=$SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Configure (Android arm64, JS-enabled gadget)
        run: |
          ./configure --host=android-arm64 -- \
            -Dgadget=enabled \
            -Dserver=disabled \
            -Dinject=disabled \
            -Dfrida_tools=disabled \
            -Dfrida_python=disabled \
            -Dfrida_node=disabled \
            -Dfrida_qml=disabled \
            -Dfrida_swift=disabled \
            -Dportal=disabled \
            -Dfrida-gum:gumjs=enabled \
            -Dfrida-gum:quickjs=enabled \
            -Dfrida-gum:v8=disabled

      - name: Force gumjs/quickjs (meson configure)
        run: |
          python3 releng/meson/meson.py configure build \
            -Dfrida-gum:gumjs=enabled \
            -Dfrida-gum:quickjs=enabled \
            -Dfrida-gum:v8=disabled

      - name: Show gumjs/quickjs status
        run: |
          if [ -f build/meson-logs/meson-log.txt ]; then
            grep -i -E "gumjs|quickjs|v8" build/meson-logs/meson-log.txt || true
          fi

      - name: Build
        run: |
          make -j"$(nproc)"

      - name: Collect gadget
        run: |
          mkdir -p dist
          find build -name "libfrida-gadget*.so*" -print -exec cp -f {} dist/ \;
          ls -la dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frida-gadget-android-arm64-js
          path: dist/
